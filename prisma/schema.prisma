// Prisma Schema per Leonardo School
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN
  STUDENT
}

enum Subject {
  BIOLOGIA
  CHIMICA
  FISICA
  MATEMATICA
  LOGICA
  CULTURA_GENERALE
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

enum SimulationType {
  FULL_TEST        // Test completo (60 domande)
  SUBJECT_TEST     // Test per materia
  CUSTOM_TEST      // Test personalizzato
  QUICK_QUIZ       // Quiz rapido (10-20 domande)
}

enum SimulationStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum AlertType {
  INFO
  WARNING
  SUCCESS
  ERROR
}

enum ContractStatus {
  PENDING      // Contratto assegnato, in attesa di firma
  SIGNED       // Contratto firmato dallo studente
  EXPIRED      // Contratto scaduto (non firmato in tempo)
  CANCELLED    // Contratto annullato dall'admin
}

enum NotificationType {
  CONTRACT_ASSIGNED    // Contratto assegnato a studente
  CONTRACT_SIGNED      // Studente ha firmato
  ACCOUNT_ACTIVATED    // Account attivato
  PROFILE_COMPLETED    // Studente ha completato profilo
  GENERAL              // Notifica generica
}

// ==================== AUTH & USERS ====================

model User {
  id               String    @id @default(cuid())
  firebaseUid      String    @unique  // Link a Firebase Auth
  email            String    @unique
  name             String
  role             UserRole  @default(STUDENT)
  isActive         Boolean   @default(false)  // true solo quando profilo completo + admin approva
  profileCompleted Boolean   @default(false)  // true quando compila dati anagrafici
  emailVerified    Boolean   @default(false)
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  lastLoginAt      DateTime?
  
  // Relations
  student          Student?
  admin            Admin?
  
  @@index([firebaseUid])
  @@index([email])
  @@map("users")
}

// ==================== STUDENTS ====================

model Student {
  id                String   @id @default(cuid())
  userId            String   @unique
  fiscalCode        String?  @unique
  dateOfBirth       DateTime?
  phone             String?
  address           String?
  city              String?
  province          String?
  postalCode        String?
  
  // School info
  classId           String?
  enrollmentDate    DateTime @default(now())
  graduationYear    Int?
  
  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  class             Class?              @relation(fields: [classId], references: [id], onDelete: SetNull)
  simulationResults SimulationResult[]
  alerts            Alert[]
  stats             StudentStats?
  contracts         Contract[]
  
  @@index([userId])
  @@index([classId])
  @@map("students")
}

// ==================== ADMIN ====================

model Admin {
  id              String   @id @default(cuid())
  userId          String   @unique
  phone           String?
  canManageUsers  Boolean  @default(false)
  canManageTests  Boolean  @default(true)
  canViewStats    Boolean  @default(true)
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("admins")
}

// ==================== CLASSES ====================

model Class {
  id            String    @id @default(cuid())
  name          String
  description   String?
  year          Int
  section       String?
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  students      Student[]
  simulations   Simulation[]
  
  @@unique([year, section])
  @@index([year])
  @@map("classes")
}

// ==================== QUESTIONS ====================

model Question {
  id              String          @id @default(cuid())
  subject         Subject
  difficulty      DifficultyLevel @default(MEDIUM)
  
  // Question content
  text            String          @db.Text
  textLatex       String?         @db.Text  // For LaTeX formulas
  imageUrl        String?
  
  // Answers (multiple choice)
  answerA         String          @db.Text
  answerB         String          @db.Text
  answerC         String          @db.Text
  answerD         String          @db.Text
  answerE         String?         @db.Text
  correctAnswer   String          // 'A', 'B', 'C', 'D', 'E'
  
  // Explanation
  explanation     String?         @db.Text
  explanationUrl  String?         // Link to video/pdf
  
  // Metadata
  tags            String[]
  year            Int?            // Year it appeared in exam
  source          String?         // "Medicina 2023", etc.
  
  isActive        Boolean         @default(true)
  timesUsed       Int             @default(0)
  avgCorrectRate  Float?          // % of correct answers
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdBy       String?         // Admin userId
  
  // Relations
  simulationQuestions SimulationQuestion[]
  
  @@index([subject])
  @@index([difficulty])
  @@index([year])
  @@index([isActive])
  @@map("questions")
}

// ==================== SIMULATIONS ====================

model Simulation {
  id              String            @id @default(cuid())
  title           String
  description     String?           @db.Text
  type            SimulationType
  status          SimulationStatus  @default(DRAFT)
  
  // Timing
  startDate       DateTime?
  endDate         DateTime?
  durationMinutes Int               // Duration in minutes
  
  // Configuration
  totalQuestions  Int
  showResults     Boolean           @default(true)  // Show results immediately
  allowReview     Boolean           @default(true)  // Allow review after completion
  randomizeOrder  Boolean           @default(false)
  
  // Scoring
  correctPoints   Float             @default(1.0)
  wrongPoints     Float             @default(-0.25)
  blankPoints     Float             @default(0.0)
  
  // Class assignment
  classId         String?
  isPublic        Boolean           @default(false)  // Available to all students
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?           // Admin userId
  
  // Relations
  class           Class?            @relation(fields: [classId], references: [id], onDelete: SetNull)
  questions       SimulationQuestion[]
  results         SimulationResult[]
  
  @@index([status])
  @@index([startDate])
  @@index([classId])
  @@index([isPublic])
  @@map("simulations")
}

model SimulationQuestion {
  id            String     @id @default(cuid())
  simulationId  String
  questionId    String
  order         Int        // Order in the simulation
  
  simulation    Simulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)
  question      Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  @@unique([simulationId, questionId])
  @@index([simulationId])
  @@index([questionId])
  @@map("simulation_questions")
}

// ==================== RESULTS ====================

model SimulationResult {
  id              String      @id @default(cuid())
  simulationId    String
  studentId       String
  
  // Timing
  startedAt       DateTime    @default(now())
  completedAt     DateTime?
  durationSeconds Int?
  
  // Scoring
  totalQuestions  Int
  correctAnswers  Int         @default(0)
  wrongAnswers    Int         @default(0)
  blankAnswers    Int         @default(0)
  totalScore      Float       @default(0.0)
  percentageScore Float       @default(0.0)
  
  // Answers (JSON array)
  answers         Json        // [{questionId, answer: 'A'|'B'|'C'|'D'|'E'|'BLANK', isCorrect, timeSpent}]
  
  // Subject breakdown (JSON)
  subjectScores   Json?       // {BIOLOGIA: {correct: 5, wrong: 2, blank: 1}, ...}
  
  // Ranking
  rankPosition    Int?
  totalParticipants Int?
  
  simulation      Simulation  @relation(fields: [simulationId], references: [id], onDelete: Cascade)
  student         Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([simulationId, studentId])
  @@index([studentId])
  @@index([simulationId])
  @@index([totalScore])
  @@index([completedAt])
  @@map("simulation_results")
}

// ==================== STATS & ANALYTICS ====================

model StudentStats {
  id                    String   @id @default(cuid())
  studentId             String   @unique
  
  // Overall stats
  totalSimulations      Int      @default(0)
  totalQuestions        Int      @default(0)
  totalCorrectAnswers   Int      @default(0)
  avgScore              Float    @default(0.0)
  bestScore             Float    @default(0.0)
  
  // Subject stats (JSON)
  subjectStats          Json?    // {BIOLOGIA: {total: 100, correct: 75, avg: 0.75}, ...}
  
  // Time stats
  totalStudyTimeMinutes Int      @default(0)
  avgSimulationTime     Int      @default(0)
  
  // Streaks
  currentStreak         Int      @default(0)
  longestStreak         Int      @default(0)
  lastActivityDate      DateTime?
  
  updatedAt             DateTime @updatedAt
  
  student               Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@map("student_stats")
}

// ==================== ALERTS & NOTIFICATIONS ====================

model Alert {
  id          String    @id @default(cuid())
  studentId   String?   // null = broadcast to all
  title       String
  message     String    @db.Text
  type        AlertType @default(INFO)
  isRead      Boolean   @default(false)
  
  // Optional link
  linkUrl     String?
  linkText    String?
  
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  
  student     Student?  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
  @@index([createdAt])
  @@index([isRead])
  @@map("alerts")
}

// ==================== EVENTS & CALENDAR ====================

model Event {
  id          String    @id @default(cuid())
  title       String
  description String?   @db.Text
  startDate   DateTime
  endDate     DateTime
  location    String?
  isPublic    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   // Admin userId
  
  @@index([startDate])
  @@index([isPublic])
  @@map("events")
}

// ==================== CONTRACTS ====================

model ContractTemplate {
  id          String    @id @default(cuid())
  name        String    // "Corso Annuale Medicina", "Corso Intensivo", etc.
  description String?   @db.Text
  content     String    @db.Text  // HTML/Markdown del contratto con placeholder
  price       Float?    // Prezzo opzionale
  duration    String?   // "12 mesi", "6 mesi", etc.
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   // Admin userId
  
  contracts   Contract[]
  
  @@index([isActive])
  @@map("contract_templates")
}

model Contract {
  id                String          @id @default(cuid())
  studentId         String
  templateId        String
  
  // Contract status
  status            ContractStatus  @default(PENDING)
  
  // Content snapshot (frozen at assignment time)
  contentSnapshot   String          @db.Text  // HTML with student data filled in
  
  // Signature
  signedAt          DateTime?
  signatureData     String?         @db.Text  // Base64 signature image or digital signature data
  signatureIp       String?         // IP address at signing
  signatureUserAgent String?        // Browser info at signing
  
  // Token for email link
  signToken         String          @unique @default(cuid())
  signTokenExpiresAt DateTime?
  
  // Timestamps
  assignedAt        DateTime        @default(now())
  expiresAt         DateTime?       // Deadline for signing
  
  // Admin notes
  adminNotes        String?         @db.Text
  assignedBy        String?         // Admin userId who assigned
  
  // Relations
  student           Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  template          ContractTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  
  @@index([studentId])
  @@index([templateId])
  @@index([status])
  @@index([signToken])
  @@map("contracts")
}

// ==================== ADMIN NOTIFICATIONS ====================

model AdminNotification {
  id          String            @id @default(cuid())
  type        NotificationType
  title       String
  message     String            @db.Text
  
  // Related entities
  studentId   String?           // Related student (if applicable)
  contractId  String?           // Related contract (if applicable)
  
  // Read status per admin (JSON: {adminId: readAt})
  readBy      Json              @default("{}")
  
  // Priority
  isUrgent    Boolean           @default(false)
  
  createdAt   DateTime          @default(now())
  expiresAt   DateTime?
  
  @@index([type])
  @@index([createdAt])
  @@index([isUrgent])
  @@map("admin_notifications")
}
